<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Monthly Loan Calculator - Calculate Home, Car & Personal Loan Payments</title>
    <meta name="description" content="Calculate your monthly loan payments, total interest, and full amortization schedule for home loans, car loans, and personal loans. Simple, fast, and free.">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Libraries for PDF and Excel download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Default Theme */
            --primary-bg-color: #4f46e5; /* indigo-600 */
            --primary-text-color: #ffffff; /* white */
            --secondary-bg-color: #f3f4f6; /* gray-100 */
            --surface-bg-color: #ffffff; /* white */
            --text-color: #1f2937; /* gray-800 */
            --sub-text-color: #4b5563; /* gray-500 */
            --border-color: #e5e7eb; /* gray-200 */
            --accent-bg-color: #f0f4ff; /* indigo-100 */
            --accent-border-color: #a5b4fc; /* indigo-300 */
            --success-color: #10b981; /* green-500 */
            --danger-color: #ef4444; /* red-500 */
            --principal-chart-color: rgb(52, 211, 153);
            --interest-chart-color: rgb(249, 115, 22);
            --balance-chart-color: rgb(239, 68, 68);
            --button-hover-color: #4338ca;
        }

        /* Trustworthy & Calm Theme */
        .theme-calm {
            --primary-bg-color: #4A6B8A;
            --primary-text-color: #ffffff;
            --secondary-bg-color: #F0F4F7;
            --surface-bg-color: #ffffff;
            --text-color: #2D3748;
            --sub-text-color: #6B7280;
            --border-color: #e5e7eb;
            --accent-bg-color: #E2E8F0;
            --accent-border-color: #94A3B8;
            --success-color: #1C9B86;
            --danger-color: #C8786A;
            --principal-chart-color: #1C9B86;
            --interest-chart-color: #C8786A;
            --balance-chart-color: #A3A3A3;
            --button-hover-color: #37536d;
        }

        /* Modern & Minimalist Theme */
        .theme-modern {
            --primary-bg-color: #5B5BD9;
            --primary-text-color: #ffffff;
            --secondary-bg-color: #f7f7f7;
            --surface-bg-color: #ffffff;
            --text-color: #333333;
            --sub-text-color: #666666;
            --border-color: #e0e0e0;
            --accent-bg-color: #f0f4ff;
            --accent-border-color: #a5b4fc;
            --success-color: #27C18E;
            --danger-color: #EB4D4B;
            --principal-chart-color: #27C18E;
            --interest-chart-color: #EB4D4B;
            --balance-chart-color: #5B5BD9;
            --button-hover-color: #4e4ecb;
        }

        /* Warm & Welcoming Theme */
        .theme-warm {
            --primary-bg-color: #E06B22;
            --primary-text-color: #ffffff;
            --secondary-bg-color: #F8F4EC;
            --surface-bg-color: #ffffff;
            --text-color: #4B3E2F;
            --sub-text-color: #7A7067;
            --border-color: #d4c8b6;
            --accent-bg-color: #FDF9F1;
            --accent-border-color: #E6D8BE;
            --success-color: #989A4B;
            --danger-color: #A04B5F;
            --principal-chart-color: #989A4B;
            --interest-chart-color: #A04B5F;
            --balance-chart-color: #E06B22;
            --button-hover-color: #c75c1c;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--secondary-bg-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem 1rem;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            max-width: 90rem;
            width: 100%;
        }
        @media (min-width: 1024px) {
            .main-grid {
                grid-template-columns: 28rem 1fr;
            }
        }
        .calculator-card, .details-card {
            background-color: var(--surface-bg-color);
            padding: 1rem 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        .input-group {
            margin-bottom: 0.75rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--sub-text-color);
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            background-color: var(--primary-bg-color);
            border-radius: 9999px;
            cursor: pointer;
            border: 2px solid var(--surface-bg-color);
            box-shadow: 0 0 0 1px var(--primary-bg-color);
            margin-top: -0.5rem;
        }
        input[type="range"]::-moz-range-thumb {
            width: 1.25rem;
            height: 1.25rem;
            background-color: var(--primary-bg-color);
            border-radius: 9999px;
            cursor: pointer;
            border: 2px solid var(--surface-bg-color);
            box-shadow: 0 0 0 1px var(--primary-bg-color);
        }
        .btn {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary-bg-color);
            color: var(--primary-text-color);
            font-weight: 600;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
            cursor: pointer;
            text-align: center;
        }
        .btn:hover {
            background-color: var(--button-hover-color);
        }
        .result-box {
            background-color: var(--accent-bg-color);
            border: 1px dashed var(--accent-border-color);
            padding: 0.75rem;
            border-radius: 0.75rem;
        }
        .slider-wrapper {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .slider-value {
            font-weight: 600;
            min-width: 6rem;
            text-align: right;
            color: var(--primary-bg-color);
        }
        .details-card {
            padding-top: 1.5rem;
            width: 100%;
        }
        .chart-container {
            height: 350px;
            width: 100%;
            margin-bottom: 1.5rem;
        }
        #amortization-table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        #amortization-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        #amortization-table th, #amortization-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            text-align: right;
        }
        #amortization-table th:first-child, #amortization-table td:first-child {
            text-align: left;
        }
        #amortization-table th {
            background-color: #f9fafb;
            color: var(--sub-text-color);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .year-row {
            background-color: #f1f5f9;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .year-row:hover {
            background-color: #e2e8f0;
        }
        .monthly-row {
            display: none;
        }
        .collapse-btn {
            font-weight: bold;
            font-size: 1.25rem;
            margin-right: 0.5rem;
            color: var(--primary-bg-color);
        }
        footer {
            background-color: var(--text-color);
            color: #d1d5db;
            padding: 1rem;
            text-align: center;
            font-size: 0.875rem;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: var(--surface-bg-color);
            padding: 2rem;
            border-radius: 1rem;
            max-width: 24rem;
            text-align: center;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .loading-animation {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-bg-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="theme-warm">

    <!-- JSON-LD Structured Data for SEO -->
    <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@graph": [
            {
              "@type": "WebPage",
              "name": "Free Monthly Loan Calculator",
              "description": "Calculate your monthly loan payments, total interest, and full amortization schedule for home loans, car loans, and personal loans. Simple, fast, and free.",
              "url": "https://easycalc.com/loan-calculator",
              "keywords": "loan calculator, monthly payment calculator, amortization schedule, home loan, car loan, personal loan, mortgage calculator"
            },
            {
              "@type": "Calculator",
              "name": "Loan Payment Calculator",
              "description": "A tool to calculate loan payments and create an amortization schedule.",
              "url": "https://easycalc.com/loan-calculator",
              "toolType": "Financial"
            }
          ]
        }
    </script>

    <!-- Header -->
    <header class="shadow-lg p-4" style="background-color: var(--primary-bg-color); color: var(--primary-text-color);">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">easyCalc</h1>
        </div>
    </header>

    <main>
        <!-- SEO-optimized content block -->
        <section class="max-w-4xl text-center mb-8">
            <h2 class="text-4xl md:text-5xl font-extrabold mb-4" style="color: var(--text-color);">Free & Simple Loan Calculator</h2>
            <p class="text-lg md:text-xl text-center mb-6" style="color: var(--sub-text-color);">
                Use our <b>free monthly loan calculator</b> to quickly determine your loan payments, total interest, and the full amortization schedule. Whether you're planning for a new <b>home loan</b>, a <b>car loan</b>, or a <b>personal loan</b>, our tool helps you make informed financial decisions with ease. Simply adjust the sliders below to see your results instantly.
            </p>
        </section>

        <div class="main-grid">
            <!-- Left Panel: Calculator Inputs -->
            <div class="calculator-card">
                <h1 class="text-3xl font-bold text-center mb-2" style="color: var(--text-color);">Loan Calculator</h1>
                <p class="text-center mb-4" style="color: var(--sub-text-color);">Calculate your monthly loan payments.</p>

                <!-- Loan Type Selection -->
                <div class="input-group">
                    <label for="loan-type-select">Loan Type</label>
                    <select id="loan-type-select" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2 border" style="color: var(--text-color);">
                        <option value="Home Loan" selected>Home Loan</option>
                        <option value="Personal Loan">Personal Loan</option>
                        <option value="Car Loan">Car Loan</option>
                    </select>
                </div>

                <!-- Currency Selection -->
                <div class="input-group">
                    <label for="currency-select">Currency</label>
                    <select id="currency-select" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2 border" style="color: var(--text-color);">
                        <option value="USD" selected>USD ($)</option>
                        <option value="EUR">EUR (€)</option>
                        <option value="JPY">JPY (¥)</option>
                        <option value="GBP">GBP (£)</option>
                        <option value="AUD">AUD ($)</option>
                        <option value="CAD">CAD ($)</option>
                        <option value="CHF">CHF (Fr)</option>
                        <option value="CNY">CNY (¥)</option>
                        <option value="SEK">SEK (kr)</option>
                        <option value="NZD">NZD ($)</option>
                        <option value="INR">INR (₹)</option>
                        <option value="BRL">BRL (R$)</option>
                        <option value="RUB">RUB (₽)</option>
                        <option value="ZAR">ZAR (R)</option>
                    </select>
                </div>

                <!-- Calculator Sliders & Number Inputs -->
                <div class="input-group">
                    <label for="loan-amount-slider">Loan Amount</label>
                    <div class="flex items-center gap-4">
                        <input type="range" id="loan-amount-slider" min="1000" max="10000000" step="1000" value="20000" class="flex-grow h-2 rounded-lg appearance-none cursor-pointer" style="background-color: var(--border-color);">
                        <input type="number" id="loan-amount-input" min="1000" max="10000000" step="1000" value="20000" class="w-24 text-right rounded-md border-gray-300 shadow-sm text-sm p-2 border" style="color: var(--text-color);">
                    </div>
                </div>
                <div class="input-group">
                    <label for="interest-rate-slider">Annual Interest Rate (%)</label>
                    <div class="flex items-center gap-4">
                        <input type="range" id="interest-rate-slider" min="0" max="20" step="0.1" value="5.5" class="flex-grow h-2 rounded-lg appearance-none cursor-pointer" style="background-color: var(--border-color);">
                        <input type="number" id="interest-rate-input" min="0" max="20" step="0.1" value="5.5" class="w-24 text-right rounded-md border-gray-300 shadow-sm text-sm p-2 border" style="color: var(--text-color);">
                    </div>
                </div>
                <div class="input-group">
                    <label for="loan-term-slider">Loan Term (Years)</label>
                    <div class="flex items-center gap-4">
                        <input type="range" id="loan-term-slider" min="1" max="30" step="1" value="5" class="flex-grow h-2 rounded-lg appearance-none cursor-pointer" style="background-color: var(--border-color);">
                        <input type="number" id="loan-term-input" min="1" max="30" step="1" value="5" class="w-24 text-right rounded-md border-gray-300 shadow-sm text-sm p-2 border" style="color: var(--text-color);">
                    </div>
                </div>

                <div class="flex items-center justify-center h-8">
                    <p id="calc-status" class="text-center text-sm" style="color: var(--sub-text-color);"></p>
                    <p id="remaining-calcs" class="text-center text-sm ml-2" style="color: var(--sub-text-color);"></p>
                </div>
                
            </div>

            <!-- Right Panel: Summary -->
            <div id="result-container" class="result-box hidden">
                <h2 class="text-xl font-semibold text-center mb-3" style="color: var(--text-color);">Loan Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="flex flex-col items-center justify-center p-3 rounded-lg border" style="background-color: var(--surface-bg-color); border-color: var(--border-color);">
                        <span class="text-sm" style="color: var(--sub-text-color);">Monthly Payment</span>
                        <p class="text-2xl font-bold mt-1" style="color: var(--primary-bg-color);"><span id="monthly-payment">0.00</span></p>
                    </div>
                    <div class="flex flex-col items-center justify-center p-3 rounded-lg border" style="background-color: var(--surface-bg-color); border-color: var(--border-color);">
                        <span class="text-sm" style="color: var(--sub-text-color);">Total Interest</span>
                        <p class="text-2xl font-bold mt-1" style="color: var(--danger-color);"><span id="total-interest">0.00</span></p>
                    </div>
                    <div class="flex flex-col items-center justify-center p-3 rounded-lg border col-span-1 md:col-span-2" style="background-color: var(--surface-bg-color); border-color: var(--border-color);">
                        <span class="text-sm" style="color: var(--sub-text-color);">Total Payment</span>
                        <p class="text-2xl font-bold mt-1" style="color: var(--success-color);"><span id="total-payment">0.00</span></p>
                    </div>
                </div>
                <div class="mt-4 pt-3 border-t" style="border-color: var(--border-color);">
                    <h3 class="text-center text-lg font-semibold mb-2" style="color: var(--text-color);">Principal vs. Interest Breakdown</h3>
                    <div class="flex justify-center w-56 h-56 mx-auto">
                        <canvas id="payment-chart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Amortization Details (full-width) -->
        <div id="amortization-details" class="details-card hidden mt-6 max-w-7xl mx-auto">
            <h2 class="text-2xl font-bold text-center mb-3" style="color: var(--text-color);">Amortization Schedule</h2>
            <div class="flex justify-center space-x-4 mb-4">
                <button id="download-pdf-btn" class="px-4 py-2 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-colors">Download PDF</button>
                <button id="download-excel-btn" class="px-4 py-2 rounded-lg font-semibold text-white bg-green-600 hover:bg-green-700 transition-colors">Download Excel</button>
            </div>
            <div class="chart-container" id="chart-container-for-pdf">
                <canvas id="amortization-chart"></canvas>
            </div>
            <div id="amortization-table-container" class="rounded-lg border overflow-hidden" style="border-color: var(--border-color);">
                <table id="amortization-table">
                    <thead>
                        <tr>
                            <th class="text-left">Year</th>
                            <th>Beginning Balance</th>
                            <th>Interest Paid</th>
                            <th>Principal Paid</th>
                            <th>Ending Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Table rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mt-auto" style="background-color: var(--text-color);">
        <div class="container mx-auto p-4 text-center">
            <p style="color: var(--primary-text-color);">&copy; 2024 easyCalc. All rights reserved.</p>
            <p class="text-xs mt-1" style="color: var(--sub-text-color);">User ID: <span id="user-id">Loading...</span></p>
        </div>
    </footer>

    <!-- Modal for freemium upgrade message -->
    <div id="freemium-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4" style="color: var(--text-color);">Unlock Unlimited Calculations!</h3>
            <p class="mb-6" style="color: var(--sub-text-color);">You've reached your free calculation limit for this session. Sign in to save your history and get unlimited calculations!</p>
            <button id="close-modal-btn" class="btn">Got It</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('debug'); // For debugging Firestore operations

        // Global variables for Firebase
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false; // New flag to track when auth is ready
        let freeCalculationsLeft = 3; // The free usage limit
        let paymentChart, amortizationChart; // Chart.js instances
        let currentCurrency = 'USD'; // Default currency
        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        let currentSchedule = []; // To store the latest amortization schedule for downloads
        
        // HTML element references
        const loanAmountSlider = document.getElementById('loan-amount-slider');
        const loanAmountInput = document.getElementById('loan-amount-input');
        const interestRateSlider = document.getElementById('interest-rate-slider');
        const interestRateInput = document.getElementById('interest-rate-input');
        const loanTermSlider = document.getElementById('loan-term-slider');
        const loanTermInput = document.getElementById('loan-term-input');

        const monthlyPaymentSpan = document.getElementById('monthly-payment');
        const totalInterestSpan = document.getElementById('total-interest');
        const totalPaymentSpan = document.getElementById('total-payment');
        const resultContainer = document.getElementById('result-container');
        const userIdSpan = document.getElementById('user-id');
        const amortizationDetails = document.getElementById('amortization-details');
        const amortizationTableBody = document.querySelector('#amortization-table tbody');
        const calcStatus = document.getElementById('calc-status');
        const remainingCalcsSpan = document.getElementById('remaining-calcs');
        const freemiumModal = document.getElementById('freemium-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const currencySelect = document.getElementById('currency-select');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const downloadExcelBtn = document.getElementById('download-excel-btn');
        
        let timeoutId;

        // Theme definitions
        const THEMES = {
            'default': {
                primary: 'rgb(79, 70, 229)', // indigo
                secondary: 'rgb(239, 68, 68)', // red
                principal: 'rgb(52, 211, 153)', // green
                interest: 'rgb(249, 115, 22)', // orange
                balance: 'rgb(239, 68, 68)' // red
            },
            'calm': {
                primary: '#4A6B8A',
                secondary: '#C8786A',
                principal: '#1C9B86',
                interest: '#C8786A',
                balance: '#A3A3A3'
            },
            'modern': {
                primary: '#5B5BD9',
                secondary: '#EB4D4B',
                principal: '#27C18E',
                interest: '#EB4D4B',
                balance: '#5B5BD9'
            },
            'warm': {
                primary: '#E06B22',
                primary_text: '#ffffff',
                secondary: '#A04B5F',
                principal: '#989A4B',
                interest: '#A04B5F',
                balance: '#E06B22'
            }
        };

        // Initial setup
        window.onload = function() {
            initializeFirebase();
            syncInputs();
            applyTheme('warm');
        };

        function initializeFirebase() {
            try {
                // Initialize Firebase with the provided config
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    console.error("Firebase config is missing or invalid. App will run in offline mode.");
                    userIdSpan.textContent = 'Offline';
                    if (calcStatus) {
                        calcStatus.textContent = 'Warning: Firebase config not found. Data will not be saved.';
                    }
                    isAuthReady = true;
                    calculateAndRender();
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in with custom token if available, otherwise anonymously
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken).then(() => {
                        console.log("Signed in with custom token.");
                    }).catch(err => {
                        console.error("Error signing in with custom token:", err);
                        signInAnonymously(auth);
                    });
                } else {
                    signInAnonymously(auth).then(() => {
                        console.log("Signed in anonymously.");
                    }).catch(err => {
                        console.error("Error signing in anonymously:", err);
                    });
                }
                
                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdSpan.textContent = userId;
                        if (remainingCalcsSpan) {
                            remainingCalcsSpan.textContent = ''; // Clear guest message
                        }
                    } else {
                        userId = 'Guest';
                        userIdSpan.textContent = userId;
                        if (remainingCalcsSpan) {
                            remainingCalcsSpan.textContent = `You have ${freeCalculationsLeft} free calculations left.`;
                        }
                    }
                    if (!isAuthReady) {
                        isAuthReady = true;
                        console.log('Firebase ready, performing initial calculation.');
                        calculateAndRender();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                userIdSpan.textContent = 'Error';
                if (calcStatus) {
                  calcStatus.textContent = 'Error: Firebase failed to initialize.';
                }
            }
        }
        
        function getCurrencySymbol() {
            const symbols = {
                'USD': '$', 'EUR': '€', 'JPY': '¥', 'GBP': '£', 'AUD': '$', 'CAD': '$',
                'CHF': 'Fr', 'CNY': '¥', '¥': '¥', 'SEK': 'kr', 'NZD': '$', 'INR': '₹', 'BRL': 'R$',
                'RUB': '₽', 'ZAR': 'R'
            };
            return symbols[currentCurrency] || currentCurrency;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currentCurrency
            }).format(value);
        }

        function syncInputs() {
            loanAmountInput.value = loanAmountSlider.value;
            interestRateInput.value = interestRateSlider.value;
            loanTermInput.value = loanTermSlider.value;
        }

        // Generate amortization schedule and summary
        function generateAmortizationSchedule(principal, annualRate, years) {
            const monthlyRate = (annualRate / 100) / 12;
            const numberOfPayments = years * 12;
            let balance = principal;
            let totalInterestPaid = 0;
            const schedule = [];
            const currentDate = new Date();

            if (monthlyRate === 0) {
                const monthlyPrincipal = principal / numberOfPayments;
                for (let i = 1; i <= numberOfPayments; i++) {
                    const paymentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + i, 1);
                    balance -= monthlyPrincipal;
                    schedule.push({
                        month: i,
                        date: paymentDate,
                        beginningBalance: principal - (monthlyPrincipal * (i - 1)),
                        interestPaid: 0,
                        principalPaid: monthlyPrincipal,
                        endingBalance: balance
                    });
                }
                return { monthlyPayment: monthlyPrincipal, totalInterest: 0, totalPayment: principal, schedule };
            }

            const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
            
            for (let i = 1; i <= numberOfPayments; i++) {
                const interestThisMonth = balance * monthlyRate;
                const principalThisMonth = monthlyPayment - interestThisMonth;
                const newBalance = balance - principalThisMonth;
                const paymentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + i, 1);

                schedule.push({
                    month: i,
                    date: paymentDate,
                    beginningBalance: balance,
                    interestPaid: interestThisMonth,
                    principalPaid: principalThisMonth,
                    endingBalance: newBalance > 0.01 ? newBalance : 0
                });

                balance = newBalance;
                totalInterestPaid += interestThisMonth;
            }

            return {
                monthlyPayment,
                totalInterest: totalInterestPaid,
                totalPayment: monthlyPayment * numberOfPayments,
                schedule
            };
        }

        function updateSummaryChart(principal, totalInterest) {
            const ctx = document.getElementById('payment-chart').getContext('2d');
            if (paymentChart) {
                paymentChart.destroy();
            }
            const currentTheme = THEMES['warm'];
            paymentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [`Principal Loan Amount`, `Total Interest`],
                    datasets: [{
                        data: [principal, totalInterest],
                        backgroundColor: [
                            currentTheme.principal,
                            currentTheme.interest
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            align: 'center',
                            labels: {
                                font: { family: 'Inter', size: 14 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    const value = tooltipItem.raw;
                                    const total = tooltipItem.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${tooltipItem.label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderAmortizationTable(schedule) {
            amortizationTableBody.innerHTML = '';
            
            const years = {};
            let beginningBalance = schedule[0].beginningBalance;

            schedule.forEach(row => {
                const year = row.date.getFullYear();
                if (!years[year]) {
                    years[year] = {
                        beginningBalance: beginningBalance,
                        principalPaid: 0,
                        interestPaid: 0,
                        rows: []
                    };
                }
                years[year].principalPaid += row.principalPaid;
                years[year].interestPaid += row.interestPaid;
                years[year].rows.push(row);
                beginningBalance = row.endingBalance;
            });
            
            for (const year in years) {
                const yearData = years[year];
                const yearRow = document.createElement('tr');
                yearRow.classList.add('year-row');
                yearRow.setAttribute('data-year', year);
                yearRow.innerHTML = `
                    <td><span class="collapse-btn">+</span>${year}</td>
                    <td>${formatCurrency(yearData.beginningBalance)}</td>
                    <td>${formatCurrency(yearData.interestPaid)}</td>
                    <td>${formatCurrency(yearData.principalPaid)}</td>
                    <td>${formatCurrency(yearData.rows[yearData.rows.length - 1].endingBalance)}</td>
                `;
                amortizationTableBody.appendChild(yearRow);

                yearData.rows.forEach(monthRowData => {
                    const monthRow = document.createElement('tr');
                    monthRow.classList.add('monthly-row');
                    monthRow.setAttribute('data-year', year);
                    monthRow.innerHTML = `
                        <td>${MONTHS[monthRowData.date.getMonth()]} ${monthRowData.date.getFullYear()}</td>
                        <td>${formatCurrency(monthRowData.beginningBalance)}</td>
                        <td>${formatCurrency(monthRowData.interestPaid)}</td>
                        <td>${formatCurrency(monthRowData.principalPaid)}</td>
                        <td>${formatCurrency(monthRowData.endingBalance)}</td>
                    `;
                    amortizationTableBody.appendChild(monthRow);
                });
            }

            // Event delegation for table collapse
            document.querySelectorAll('.year-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    const year = row.getAttribute('data-year');
                    const btn = row.querySelector('.collapse-btn');
                    const isCollapsed = btn.textContent === '+';

                    document.querySelectorAll(`.monthly-row[data-year="${year}"]`).forEach(monthRow => {
                        monthRow.style.display = isCollapsed ? 'table-row' : 'none';
                    });
                    btn.textContent = isCollapsed ? '−' : '+';
                });
            });
        }

        function renderCombinedChart(schedule) {
            const ctx = document.getElementById('amortization-chart').getContext('2d');
            if (amortizationChart) {
                amortizationChart.destroy();
            }
            
            const yearlyData = {};
            let beginningBalance = schedule[0].beginningBalance;

            schedule.forEach(row => {
                const year = row.date.getFullYear();
                if (!yearlyData[year]) {
                    yearlyData[year] = {
                        principal: 0,
                        interest: 0,
                        endingBalance: 0,
                        beginningBalance: beginningBalance
                    };
                }
                yearlyData[year].principal += row.principalPaid;
                yearlyData[year].interest += row.interestPaid;
                yearlyData[year].endingBalance = row.endingBalance;
                beginningBalance = row.endingBalance;
            });

            const labels = Object.keys(yearlyData);
            const principalData = labels.map(year => yearlyData[year].principal);
            const interestData = labels.map(year => yearlyData[year].interest);
            const balanceData = labels.map(year => yearlyData[year].beginningBalance);
            
            const currentTheme = THEMES['warm'];

            amortizationChart = new Chart(ctx, {
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: `Principal Paid`,
                            data: principalData,
                            backgroundColor: currentTheme.principal,
                            yAxisID: 'y',
                            order: 0
                        },
                        {
                            type: 'bar',
                            label: `Interest Paid`,
                            data: interestData,
                            backgroundColor: currentTheme.interest,
                            yAxisID: 'y',
                            order: 0
                        },
                        {
                            type: 'line',
                            label: `Outstanding Balance`,
                            data: balanceData,
                            borderColor: currentTheme.balance,
                            backgroundColor: currentTheme.balance,
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 5,
                            fill: false,
                            yAxisID: 'y1',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Year'
                            },
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: `Payment Per Year`
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: `Outstanding Balance`
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatCurrency(context.raw);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Function to create a PDF from the chart and table
        async function downloadPDF() {
            if (!currentSchedule || currentSchedule.length === 0) {
                calcStatus.textContent = 'Please run a calculation first.';
                return;
            }

            calcStatus.textContent = 'Generating PDF...';
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'letter');
            const pageMargin = 40;
            const headerHeight = 70;

            // Define header function to be called on each page
            const addPageHeader = (doc, loanType, loanAmount, interestRate, loanTerm) => {
                const currencySymbol = getCurrencySymbol();
                doc.setFontSize(22);
                doc.text('Amortization Schedule', doc.internal.pageSize.width / 2, pageMargin, { align: 'center' });
                doc.setFontSize(12);
                doc.text(`Loan Type: ${loanType}`, pageMargin, pageMargin + 20);
                doc.text(`Loan Amount: ${currencySymbol}${loanAmount}`, doc.internal.pageSize.width / 2, pageMargin + 20, { align: 'left' });
                doc.text(`Interest Rate: ${interestRate}%`, pageMargin, pageMargin + 35);
                doc.text(`Loan Term: ${loanTerm} years`, doc.internal.pageSize.width / 2, pageMargin + 35, { align: 'left' });
                return pageMargin + 40; // Return Y position after header
            };

            // Get loan details for headers
            const loanType = document.getElementById('loan-type-select').value;
            const loanAmount = parseFloat(loanAmountSlider.value);
            const interestRate = parseFloat(interestRateSlider.value);
            const loanTerm = parseFloat(loanTermSlider.value);

            // Add the chart and initial table heading to the first page
            let yOffset = addPageHeader(doc, loanType, loanAmount, interestRate, loanTerm);
            yOffset += 50;

            doc.setFontSize(16);
            doc.text('Principal, Interest, and Balance over time', pageMargin, yOffset);
            yOffset += 10;
            
            const chartCanvas = document.getElementById('amortization-chart');
            const chartImage = chartCanvas.toDataURL('image/png', 1.0);
            doc.addImage(chartImage, 'PNG', pageMargin, yOffset, doc.internal.pageSize.width - pageMargin * 2, 250);
            yOffset += 260; // Adjust offset for the chart
            
            // Add the table header
            doc.setFontSize(16);
            doc.text('Payment Schedule', pageMargin, yOffset);
            yOffset += 20;

            const headers = [
                'Year',
                'Beginning Balance',
                'Interest Paid',
                'Principal Paid',
                'Ending Balance'
            ];
            
            // Prepare table data
            const tableData = [];
            const years = {};
            let beginningBalance = currentSchedule[0].beginningBalance;

            currentSchedule.forEach(row => {
                const year = row.date.getFullYear();
                if (!years[year]) {
                    years[year] = {
                        beginningBalance: beginningBalance,
                        principalPaid: 0,
                        interestPaid: 0,
                        rows: []
                    };
                }
                years[year].principalPaid += row.principalPaid;
                years[year].interestPaid += row.interestPaid;
                years[year].rows.push(row);
                beginningBalance = row.endingBalance;
            });
            
            for (const year in years) {
                const yearData = years[year];
                tableData.push([
                    year,
                    formatCurrency(yearData.beginningBalance),
                    formatCurrency(yearData.interestPaid),
                    formatCurrency(yearData.principalPaid),
                    formatCurrency(yearData.rows[yearData.rows.length - 1].endingBalance)
                ]);

                yearData.rows.forEach(monthRowData => {
                    tableData.push([
                        `  ${MONTHS[monthRowData.date.getMonth()]} ${monthRowData.date.getFullYear()}`,
                        formatCurrency(monthRowData.beginningBalance),
                        formatCurrency(monthRowData.interestPaid),
                        formatCurrency(monthRowData.principalPaid),
                        formatCurrency(monthRowData.endingBalance)
                    ]);
                });
            }

            // Generate table in PDF using autoTable plugin with pagination options
            doc.autoTable({
                startY: yOffset,
                head: [headers],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0] },
                alternateRowStyles: { fillColor: [250, 250, 250] },
                styles: { font: 'Inter', fontSize: 10, cellPadding: 5 },
                margin: { left: pageMargin, right: pageMargin, bottom: pageMargin },
                didDrawPage: function(data) {
                    // Only add header to the first page
                    if (data.pageNumber === 1) {
                         addPageHeader(doc, loanType, loanAmount, interestRate, loanTerm);
                    }
                    // Footer
                    let str = "Page " + doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    const pageNumber = data.pageNumber || doc.internal.getNumberOfPages();
                    str = "Page " + pageNumber;
                    if (typeof doc.autoTable.previous.totalPageNumber !== 'undefined') {
                        str += " of " + doc.autoTable.previous.totalPageNumber;
                    }
                    doc.text(str, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
                }
            });

            doc.save('Amortization_Schedule.pdf');
            calcStatus.textContent = 'PDF downloaded!';
            setTimeout(() => calcStatus.textContent = '', 2000);
        }

        // Function to create and download an Excel (CSV) file
        function downloadExcel() {
            if (!currentSchedule || currentSchedule.length === 0) {
                calcStatus.textContent = 'Please run a calculation first.';
                return;
            }

            calcStatus.textContent = 'Generating Excel...';
            const headers = ["Payment No.", "Date", "Beginning Balance", "Interest Paid", "Principal Paid", "Ending Balance"];
            let csvContent = headers.join(",") + "\n";

            currentSchedule.forEach(row => {
                const dateString = row.date.toISOString().substring(0, 10);
                const rowData = [
                    row.month,
                    dateString,
                    row.beginningBalance.toFixed(2),
                    row.interestPaid.toFixed(2),
                    row.principalPaid.toFixed(2),
                    row.endingBalance.toFixed(2)
                ];
                csvContent += rowData.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'Amortization_Schedule.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            calcStatus.textContent = 'Excel downloaded!';
            setTimeout(() => calcStatus.textContent = '', 2000);
        }


        function calculateAndRender() {
            // Wait for auth to be ready before proceeding
            if (!isAuthReady) {
              return;
            }

            // Freemium logic
            if (userId === 'Guest' && freeCalculationsLeft <= 0) {
                freemiumModal.classList.remove('hidden');
                return;
            }

            const amount = parseFloat(loanAmountSlider.value);
            const rate = parseFloat(interestRateSlider.value);
            const term = parseFloat(loanTermSlider.value);
            const loanType = document.getElementById('loan-type-select').value;

            if (isNaN(amount) || isNaN(rate) || isNaN(term) || amount <= 0 || rate < 0 || term <= 0) {
                calcStatus.textContent = 'Invalid input values.';
                resultContainer.classList.add('hidden');
                amortizationDetails.classList.add('hidden');
                return;
            }

            calcStatus.textContent = 'Calculating...';
            
            const calculation = generateAmortizationSchedule(amount, rate, term);
            currentSchedule = calculation.schedule; // Store the schedule for downloads
            
            // Update summary
            monthlyPaymentSpan.textContent = formatCurrency(calculation.monthlyPayment);
            totalInterestSpan.textContent = formatCurrency(calculation.totalInterest);
            totalPaymentSpan.textContent = formatCurrency(calculation.totalPayment);
            resultContainer.classList.remove('hidden');
            updateSummaryChart(amount, calculation.totalInterest);

            // Update detailed breakdown
            amortizationDetails.classList.remove('hidden');
            renderAmortizationTable(calculation.schedule);
            renderCombinedChart(calculation.schedule, calculation.monthlyPayment);

            // Decrement free calculations if it's a guest user
            if (userId === 'Guest') {
                freeCalculationsLeft--;
                if (remainingCalcsSpan) {
                    remainingCalcsSpan.textContent = `You have ${freeCalculationsLeft} free calculations left.`;
                }
            }
            calcStatus.textContent = ''; // Clear status message

            // Save to Firestore
            if (db && userId !== 'Guest') {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const calculationsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'calculations');
                    addDoc(calculationsCollectionRef, {
                        amount: amount,
                        rate: rate,
                        term: term,
                        loanType: loanType,
                        monthlyPayment: calculation.monthlyPayment,
                        totalInterest: calculation.totalInterest,
                        totalPayment: calculation.totalPayment,
                        amortizationSchedule: JSON.stringify(calculation.schedule.map(row => ({
                            ...row,
                            date: row.date.toISOString() // Convert date object to string for Firestore
                        }))),
                        createdAt: new Date().toISOString()
                    });
                } catch (e) {
                    console.error("Error adding document: ", e);
                    if (calcStatus) {
                      calcStatus.textContent = 'Failed to save calculation. Check console for details.';
                    }
                }
            }
        }

        function applyTheme(themeName) {
            const root = document.documentElement;
            const themeClass = `theme-${themeName}`;
            
            // Clear all theme classes
            document.body.className = '';
            document.body.classList.add(themeClass);

            // Update chart colors
            if (paymentChart) {
                const currentTheme = THEMES[themeName];
                paymentChart.data.datasets[0].backgroundColor = [currentTheme.principal, currentTheme.interest];
                paymentChart.update();
            }
            if (amortizationChart) {
                const currentTheme = THEMES[themeName];
                amortizationChart.data.datasets[0].backgroundColor = currentTheme.principal;
                amortizationChart.data.datasets[1].backgroundColor = currentTheme.interest;
                amortizationChart.data.datasets[2].borderColor = currentTheme.balance;
                amortizationChart.data.datasets[2].backgroundColor = currentTheme.balance;
                amortizationChart.update();
            }
        }


        // --- Event Listeners ---
        const allInputs = [loanAmountSlider, loanAmountInput, interestRateSlider, interestRateInput, loanTermSlider, loanTermInput];
        allInputs.forEach(input => {
            input.addEventListener('input', () => {
                clearTimeout(timeoutId);
                syncInputs();
                calcStatus.textContent = 'Calculating...';
                timeoutId = setTimeout(() => {
                    calculateAndRender();
                }, 300); // Debounce for 300ms
            });
        });

        loanAmountInput.addEventListener('change', () => {
            loanAmountSlider.value = loanAmountInput.value;
            calculateAndRender();
        });

        interestRateInput.addEventListener('change', () => {
            interestRateSlider.value = interestRateInput.value;
            calculateAndRender();
        });
        
        loanTermInput.addEventListener('change', () => {
            loanTermSlider.value = loanTermInput.value;
            calculateAndRender();
        });

        currencySelect.addEventListener('change', () => {
            currentCurrency = currencySelect.value;
            calculateAndRender();
        });

        downloadPdfBtn.addEventListener('click', downloadPDF);
        downloadExcelBtn.addEventListener('click', downloadExcel);

        // Close modal button listener
        closeModalBtn.addEventListener('click', () => {
            freemiumModal.classList.add('hidden');
        });
    </script>
</body>
</html>
